name: cdvae-action

on: [push, pull_request]

# jobs:
#   miniconda:
#     name: Miniconda ${{ matrix.os }}
#     runs-on: ${{ matrix.os }}
#     strategy:
#         matrix:
#             os: ["ubuntu-latest"]
#             python-version: ["3.8"]
#     steps:
#       - uses: actions/checkout@v2
#       - uses: goanpeca/setup-miniconda@v1
#         with:
#           activate-environment: cdvae
#           environment-file: env.kc.yml 
#           python-version: ${{ matrix.python-version }}
#           auto-activate-base: false
#           ACTIONS_ALLOW_UNSECURE_COMMANDS: true
#       - shell: bash -l {0}
#         run: |
#           conda info
#           conda list
#       - name: Lint
#         shell: bash -l {0}
#         run: |
#             conda activate cdvae
#             conda install flake8
#             python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
#             python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
#             pip install -e .
#             export PROJECT_ROOT=$PWD
#             export WABDB=$PWD/WABDB 
#             export HYDRA_JOBS=$PWD/HYDRA_JOBS  
#             python cdvae/run.py data=perov expname=perov model.predict_property=True
            
#       - name: Run pytest
#         shell: bash -l {0}
#         run: |
#             conda install pytest
#             pytest









jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        
        conda env create -n cdvae --file env.kc.yml  
        source "$HOME/.bashrc"
        source $CONDA_PREFIX/etc/profile.d/conda.sh
        #conda run -n cdvae /bin/bash
        conda activate cdvae
        pip install -e .
        export PROJECT_ROOT=$PWD
        export WABDB=$PWD/WABDB 
        export HYDRA_JOBS=$PWD/HYDRA_JOBS  
        
        
#      https://github.com/ben-heil/github_actions_test/blob/master/.github/workflows/miniconda.yml
#    - name: Lint
#      run: |
#        pip install flake8 pytest pycodestyle pydocstyle
#        pycodestyle --ignore E203,W503 --exclude=tests cdvae
#        pydocstyle --match-dir=core --match-dir=io --match-dir=io --match-dir=ai --match-dir=analysis --match-dir=db --match-dir=tasks --count cdvae
#        flake8 --ignore E203,W503 --exclude=tests --statistics --count --exit-zero cdvae
#     - name: Test with pytest
#       run: |
#         export DGLBACKEND=pytorch
#         pip install flake8 pytest pycodestyle pydocstyle codecov pytest-cov coverage 
#         echo 'PIP freeze'
#         pip freeze
#         coverage run -m pytest
#         coverage report -m
#         codecov
#         codecov --token="85bd9c5d-9e55-4f6d-bd69-350ee5e3bb41"
#         echo 'Train folder'
#         train_folder.py -h 
#         echo 'Pre-trained models'
#         pretrained.py -h
#         #train_folder.py --root_dir "alignn/examples/sample_data" --config "alignn/examples/sample_data/config_example.json" --output_dir=temp
